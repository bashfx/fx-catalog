# TASK-004: Implement FEATURE-004 (Package Integrity + PATH Linking)

- **Date**: 2023-10-27
- **Objective**: Implement the verification and linking logic in `devfx`. This involves validating file checksums against the manifest, flagging the system for repair on mismatch, and creating symlinks for executable packages.
- **Branch**: `g-feat-integrity-20231027`

---

## Strategy & Code Plan

This feature assumes that `manifest.log` has been generated by the `install` command. The logic will be exposed through `verify` and `link` commands in `devfx`.

### Sub-task 4.1 & 4.2: Integrity Check & Tamper Flag

**Function:** `fx_verify_packages`

**Purpose:**
- Read `manifest.log` and validate the checksum of each installed file.
- If any file has been tampered with (checksum mismatch), flag the system by setting `FX_REPAIR=true` in `.fxrc`.

**Implementation Steps:**
1.  Define the manifest path: `MANIFEST_FILE="$FX_CONFIG_DIR/manifest.log"`.
2.  Use a `while read -r expected_sum alias file_path; do ... done < "$MANIFEST_FILE"` loop to process the manifest.
3.  Inside the loop, calculate the current checksum: `current_sum=$(md5sum "$file_path" | awk '{print $1}')`.
4.  If `[ "$current_sum" != "$expected_sum" ]`, call `fx_flag_for_repair` and log a warning.

**Helper Function:** `fx_flag_for_repair`

**Purpose:**
- Atomically add or uncomment `export FX_REPAIR=true` in the user's `.fxrc` file.

**Implementation Steps:**
1.  Use `grep -q "FX_REPAIR=true" "$FX_RC"` to check if the flag is already set.
2.  If not, `echo "export FX_REPAIR=true" >> "$FX_RC"`.

### Sub-task 4.3: Executable Symlinking

**Function:** `fx_link_executables`

**Purpose:**
- Create symlinks in `$FX_BIN_DIR` for all `core` and `utils` packages that pass verification.

**Implementation Steps:**
1.  Loop through the `manifest.log` as in the verification step.
2.  For each entry, re-verify the checksum.
3.  If the checksum is valid AND the `file_path` is in `$FX_LIB_HOME/core/` or `$FX_LIB_HOME/utils/`, proceed to link.
4.  Create the symlink: `ln -sf "$file_path" "$FX_BIN_DIR/$alias"`. The `-f` ensures the command is idempotent.

### Orchestration

1.  A `verify` command will be added to `devfx` to call `fx_verify_packages`.
2.  A `link` command will be added to `devfx` to call `fx_link_executables`.
3.  The main `setup` command will be updated to call `verify` and `link` as final steps.
